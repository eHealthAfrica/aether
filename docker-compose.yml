# ------------------------------------------------------------------------------
# Config file for ALL containers:
#
#  * Aether Kernel
#  * ODK Module
#  * CouchDB Sync Module
# ------------------------------------------------------------------------------

version: "2.1"

networks:
  internal:  # alias as internal
    external:
      name: aether_internal  # if this isn't explicitly set it inherits from the containing folder name (aether or not)


services:

  # ---------------------------------
  # Database containers
  # ---------------------------------

  db:
    extends:
      file: docker-compose-base.yml
      service: postgres-base
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - internal

  couchdb:
    extends:
      file: docker-compose-base.yml
      service: couchdb-base
    networks:
      - internal

  kong-migration:
    extends:
      file: docker-compose-base.yml
      service: kong-migration-base
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal

  kong:
    extends:
      file: docker-compose-base.yml
      service: kong-base
    healthcheck:
      test: ["CMD", "curl", "-f", "http://kong:8001" ]
      interval: 3s
      timeout: 3s
      retries: 5
    depends_on:
      kong-migration:
        condition: service_started
    # FIXME: bring back these once we have figured out the reason for
    #
    #     ERROR: for kong-migration  Service "db" is missing a healthcheck configuration
    #
    # depends_on:
      # db:
      #   condition: service_healthy
      # kong-migration:
      #   condition: service_started
    networks:
      internal:
        aliases:
          - ${PROJECT_API_URL}

  kongfig:
    extends:
      file: docker-compose-base.yml
      service: kongfig
    links:
      - 'kong:kong'
    networks:
      - internal

  redis:
    extends:
      file: docker-compose-base.yml
      service: redis-base
    networks:
      - internal


  # ---------------------------------
  # Kong
  # ---------------------------------

  kong-database:
    image: postgres:9.6
    environment:
      - POSTGRES_USER=kong
      - POSTGRES_DB=kong
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  kong-migration:
    image: kong
    environment:
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-database
    command: kong migrations up
    depends_on:
      kong-database:
        condition: service_healthy
    links:
      - kong-database

  kong:
    image: kong
    restart: on-failure
    ports:
      - 8449:8449
      - 8001:8001
      - ${KONG_PORT}:${KONG_PORT}
    environment:
      - KONG_ADMIN_LISTEN=0.0.0.0:8001
      - KONG_PROXY_LISTEN_SSL=0.0.0.0:8449
      - KONG_PROXY_LISTEN=0.0.0.0:${KONG_PORT}
      - KONG_DATABASE=postgres
      - KONG_PG_HOST=kong-database
    healthcheck:
      test: ["CMD", "curl", "-f", "http://kong:8001" ]
      interval: 3s
      timeout: 3s
      retries: 5
    depends_on:
      - kong-migration
    links:
      - kong-database

  kongfig:
    image: mashupmill/kongfig
    build:
      context: aether-kongfig
    volumes:
    # Register all modular kongfig files as volumes to have them pushed to kong
      - ./aether-kernel/kongfig.yml:/config/_kernel-kongfig.yml
      - ./aether-odk-module/kongfig.yml:/config/odk-kongfig.yml
      - ./aether-couchdb-sync-module/kongfig.yml:/config/sync-kongfig.yml
    environment:
      - KONG_PORT=${KONG_PORT}
    depends_on:
      - kong
    links:
      - kong


  # ---------------------------------
  # Aether Kernel
  # ---------------------------------

  kernel:
    extends:
      file: docker-compose-base.yml
      service: kernel-base
    # uncomment to speed up common module development
    # volumes:
    #   - ./aether-common-module/aether/common:/code/aether/common
    depends_on:
      - db
      - kong
      - kongfig
    networks:
      internal:
        aliases:
          - kernel.aether.local


  # ---------------------------------
  # ODK module
  # ---------------------------------

  odk:
    extends:
      file: docker-compose-base.yml
      service: odk-base
    # uncomment to speed up common module development
    # volumes:
    #   - ./aether-common-module/aether/common:/code/aether/common
    depends_on:
      - db
      - kernel
    networks:
      internal:
        aliases:
          - odk.aether.local


  # ---------------------------------
  # CouchDB Sync module
  # ---------------------------------

  couchdb-sync:
    extends:
      file: docker-compose-base.yml
      service: couchdb-sync-base
    # uncomment to speed up common module development
    # volumes:
    #   - ./aether-common-module/aether/common:/code/aether/common
    depends_on: &sync-dependencies
      - couchdb
      - db
      - kernel
      - redis
    networks:
      internal:
        aliases:
          - sync.aether.local

  couchdb-sync-rq:
    extends:
      file: docker-compose-base.yml
      service: couchdb-sync-rq-base
    depends_on: *sync-dependencies
    networks:
      - internal

  # ---------------------------------
  # Aether UI module
  # ---------------------------------

  ui:
    extends:
      file: docker-compose-base.yml
      service: ui-base
    # uncomment to speed up common module development
    # volumes:
    #   - ./aether-common-module/aether/common:/code/aether/common
    depends_on:
      - db
      - kernel
      - ui-webpack
    networks:
      internal:
        aliases:
          - ui.aether.local

  ui-webpack:
    extends:
      file: docker-compose-base.yml
      service: ui-webpack-base
    networks:
      - internal


  # ---------------------------------
  # NGINX container
  # ---------------------------------

  nginx:
    extends:
      file: docker-compose-base.yml
      service: nginx-base
    networks:
      - internal
