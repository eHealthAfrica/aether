# ------------------------------------------------------------------------------
# Config file for these containers:
#
#  * Aether Kernel
#  * ODK Module
#  * CouchDB Sync Module
#  * Aether UI Module
# ------------------------------------------------------------------------------

version: "2.1"

networks:
  internal:  # alias as internal
    external:
      name: aether_internal  # if this isn't explicitly set it inherits from the containing folder name (aether or not)


services:

  # ---------------------------------
  # Database containers
  # ---------------------------------

  db:
    extends:
      file: docker-compose-base.yml
      service: postgres-base
    volumes:
      # data volume
      - ./.persistent_data/db/data:/var/lib/postgresql/data
    networks:
      - internal

  couchdb:
    extends:
      file: docker-compose-base.yml
      service: couchdb-base
    networks:
      - internal

  redis:
    extends:
      file: docker-compose-base.yml
      service: redis-base
    networks:
      - internal


  # ---------------------------------
  # Aether Kernel
  # ---------------------------------

  kernel:
    extends:
      file: docker-compose-base.yml
      service: kernel-base
    depends_on:
      db:
        condition: service_healthy
    networks:
      internal:
        aliases:
          - kernel.aether.local


  # ---------------------------------
  # ODK module
  # ---------------------------------

  odk:
    extends:
      file: docker-compose-base.yml
      service: odk-base
    depends_on:
      db:
        condition: service_healthy
      kernel:
        condition: service_started
    networks:
      internal:
        aliases:
          - odk.aether.local


  # ---------------------------------
  # CouchDB Sync module
  # ---------------------------------

  couchdb-sync:
    extends:
      file: docker-compose-base.yml
      service: couchdb-sync-base
    depends_on: &sync-dependencies
      db:
        condition: service_healthy
      couchdb:
        condition: service_started
      kernel:
        condition: service_started
      redis:
        condition: service_started
    networks:
      internal:
        aliases:
          - sync.aether.local

  couchdb-sync-rq:
    extends:
      file: docker-compose-base.yml
      service: couchdb-sync-rq-base
    depends_on: *sync-dependencies
    networks:
      - internal

  # ---------------------------------
  # Aether UI module
  # ---------------------------------

  ui:
    extends:
      file: docker-compose-base.yml
      service: ui-base
    depends_on:
      db:
        condition: service_healthy
      kernel:
        condition: service_started
      # UI depends on "ui-assets" to serve the assets with hot reloading (HMR)
      # to start "ui" without HMR execute first "docker-compose run ui-assets build"
      # - ui-assets
    networks:
      internal:
        aliases:
          - ui.aether.local

  ui-assets:
    extends:
      file: docker-compose-base.yml
      service: ui-assets-base
    networks:
      - internal


  # ---------------------------------
  # NGINX container
  # ---------------------------------

  nginx:
    extends:
      file: docker-compose-base.yml
      service: nginx-base
    networks:
      - internal
