version: "2"

services:

    # ---------------------------------
    # Databases containers
    # ---------------------------------

    db-test:
        image: postgres:9.5.2

    couchdb-test:
        image: couchdb:1.6
        environment:
            COUCHDB_USER: admin
            COUCHDB_PASSWORD: secret
        volumes:
            # enable cors for mobile app in-browser development:
            - ./aether-couchdb-sync/couchdb/conf/config.ini:/usr/local/etc/couchdb/local.ini
        ports:
            - "5984:5984"

    redis-test:
        image: redis:3.2-alpine


    # ---------------------------------
    # Aether Kernel container
    # ---------------------------------

    kernel-test:
        build: aether-kernel
        stdin_open: true
        tty: true
        environment:
            CAS_SERVER_URL: https://ums-dev.ehealthafrica.org
            CSRF_COOKIE_DOMAIN: .aether.local
            TESTING: "true"
            HOSTNAME: kernel.aether.local

            RDS_DB_NAME: kernel-test
            RDS_HOSTNAME: db-test
            RDS_PASSWORD: ""
            RDS_PORT: 5432
            RDS_USERNAME: postgres

            WEB_SERVER_PORT: 9000
        volumes:
            - ./aether-kernel:/code
        depends_on:
            - db-test
        ports:
            - "9000:9000"
        depends_on:
            - db-test
        command: start_dev


    # ---------------------------------
    # ODK Adapter container
    # ---------------------------------

    odk-importer-test:
        build: aether-odk-importer
        environment:
            CAS_SERVER_URL: https://ums-dev.ehealthafrica.org
            CSRF_COOKIE_DOMAIN: .aether.local
            TESTING: "true"
            HOSTNAME: odk.aether.local

            AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24
            AETHER_KERNEL_URL_TEST: http://kernel-test:9000

            RDS_DB_NAME: odk-importer-test
            RDS_HOSTNAME: db-test
            RDS_PASSWORD: ""
            RDS_PORT: 5432
            RDS_USERNAME: postgres

            WEB_SERVER_PORT: 9443
        volumes:
            - ./aether-odk-importer:/code
        depends_on:
            - kernel-test
            - db-test
        ports:
            - "9443:9443"
        depends_on:
            - db-test
            - kernel-test
        command: start_dev


    # ---------------------------------
    # Mobile Sync container
    # ---------------------------------

    couchdb-sync-test:
        build: aether-couchdb-sync
        environment:
            CAS_SERVER_URL: https://ums-dev.ehealthafrica.org
            CSRF_COOKIE_DOMAIN: .aether.local
            TESTING: "true"
            HOSTNAME: sync.aether.local

            COUCHDB_PASSWORD: secret
            COUCHDB_URL: http://couchdb-test:5984
            COUCHDB_USER: admin

            AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24
            AETHER_KERNEL_URL_TEST: http://kernel-test:9000

            GOOGLE_CLIENT_ID: "${GOOGLE_CLIENT_ID}"

            RDS_DB_NAME: couchdb-sync-test
            RDS_HOSTNAME: db-test
            RDS_PASSWORD: ""
            RDS_PORT: 5432
            RDS_USERNAME: postgres

            REDIS_DB: 0
            REDIS_HOST: redis-test
            REDIS_PASSWORD: ""
            REDIS_PORT: 6379

            WEB_SERVER_PORT: 9666
        volumes:
            - ./aether-couchdb-sync:/code
        depends_on:
            - kernel-test
            - couchdb-test
            - db-test
            - redis-test
        ports:
            - "9666:9666"
        depends_on:
            - db-test
            - redis-test
            - couchdb-test
            - kernel-test
        command: start_dev


    # ---------------------------------
    # UI container
    # ---------------------------------

    ui-test:
        build: aether-ui
        environment: &ui-environment
            CAS_SERVER_URL: https://ums-dev.ehealthafrica.org
            CSRF_COOKIE_DOMAIN: .aether.local
            TESTING: "true"
            HOSTNAME: ui.aether.local
            STATIC_ROOT: /code/aether/ui/assets/bundles

            AETHER_ORG_NAME: eHealth Africa (Dev mode)

            AETHER_KERNEL_TOKEN: a2d6bc20ad16ec8e715f2f42f54eb00cbbea2d24
            AETHER_KERNEL_URL_TEST: http://kernel-test:9000

            AETHER_MODULES: "odk-importer"

            AETHER_ODK_TOKEN: d5184a044bb5acff89a76ec4e67d0fcddd5cd3a1
            AETHER_ODK_URL_TEST: http://odk-importer-test:9443

            RDS_DB_NAME: ui-test
            RDS_HOSTNAME: db-test
            RDS_PASSWORD: ""
            RDS_PORT: 5432
            RDS_USERNAME: postgres

            WEB_SERVER_PORT: 9090
        volumes:
            #################################################
            #                    WARNING                    #
            # do not include the root folder as volume or   #
            # `node_modules` folder will not be available   #
            #                                               #
            # - ./aether-ui:/code # DO NOT UNCOMMENT!!!    #
            #################################################

            - ./aether-ui/conf:/code/conf
            - ./aether-ui/aether:/code/aether

            - ./aether-ui/entrypoint.sh:/code/entrypoint.sh
            - ./aether-ui/manage.py:/code/manage.py
            - ./aether-ui/package.json:/code/package.json
        depends_on:
            - kernel-test
            - db-test
            - odk-importer-test
        ports:
            - "9090:9090"
        depends_on:
            - db-test
            - kernel-test
            - odk-importer-test
        command: start_dev


    # ---------------------------------
    # Aether Common module container
    # ---------------------------------

    common-test:
        build: aether-common
        environment:
            TESTING: "true"
        volumes:
            - ./aether-common:/code
        command: test
