# ------------------------------------------------------------------------------
# Config file for ALL TESTING containers:
#
#  * Aether Kernel
#  * ODK Module
#  * CouchDB Sync Module
# ------------------------------------------------------------------------------

version: "2.1"

services:

  # ---------------------------------
  # Database containers
  # ---------------------------------

  db-test:
    extends:
      file: docker-compose-base.yml
      service: postgres-base
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  couchdb-test:
    extends:
      file: docker-compose-base.yml
      service: couchdb-base

  redis-test:
    extends:
      file: docker-compose-base.yml
      service: redis-base

  kong-migration-test:
    extends:
      file: docker-compose-base.yml
      service: kong-migration-base
    environment:
      - KONG_PG_HOST=db-test
    depends_on:
      db-test:
        condition: service_healthy

  kong:
    extends:
      file: docker-compose-base.yml
      service: kong-base
    environment:
      - KONG_PG_HOST=db-test
    healthcheck:
      test: ["CMD", "curl", "-f", "http://kong:8001" ]
      interval: 3s
      timeout: 3s
      retries: 5
    depends_on:
      db-test:
        condition: service_healthy
      kong-migration-test:
        condition: service_started

  # ---------------------------------
  # Aether Kernel
  # ---------------------------------

  kernel-test:
    extends:
      file: docker-compose-base.yml
      service: kernel-base
    environment:
      TESTING: "true"
      MEDIA_ROOT: /tmp/
      RDS_DB_NAME: kernel-test
      RDS_HOSTNAME: db-test
      WEB_SERVER_PORT: 9000
    depends_on:
      - db-test
      - kong
    ports:
      - "9000:9000"


  # ---------------------------------
  # ODK module
  # ---------------------------------

  odk-test:
    extends:
      file: docker-compose-base.yml
      service: odk-base
    environment:
      TESTING: "true"
      MEDIA_ROOT: /tmp/
      AETHER_KERNEL_URL: http://kernel-test:9000
      RDS_DB_NAME: odk-test
      RDS_HOSTNAME: db-test
      WEB_SERVER_PORT: 9443
    depends_on:
      - db-test
      - kernel-test
    ports:
      - "9443:9443"


  # ---------------------------------
  # CouchDB Sync module
  # ---------------------------------

  couchdb-sync-test:
    extends:
      file: docker-compose-base.yml
      service: couchdb-sync-base
    environment:
      TESTING: "true"
      MEDIA_ROOT: /tmp/
      AETHER_KERNEL_URL: http://kernel-test:9000
      COUCHDB_URL: http://couchdb-test:5984
      RDS_DB_NAME: couchdb-sync-test
      RDS_HOSTNAME: db-test
      REDIS_HOST: redis-test
      WEB_SERVER_PORT: 9666
    depends_on:
      - couchdb-test
      - db-test
      - kernel-test
      - redis-test
    ports:
      - "9666:9666"

  # ---------------------------------
  # Aether Client container
  # ---------------------------------
  client-test:
    build: aether-client
    image: aether/client

    volumes:
      - ./aether-client:/code

    depends_on:
      - db-test
      - kernel-test
